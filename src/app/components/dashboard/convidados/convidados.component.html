<div class="convidados-wrapper">
  <div class="convidados-header">
    <h2>{{ getHeaderTitle() }}</h2>
    <button class="btn btn-primary btn-md" (click)="toggleForm()" *ngIf="!showForm">
      {{ showForm ? 'Cancelar' : '+ Novo Convidado' }}
    </button>
  </div>

  <!-- Mensagens de feedback -->
  <div class="alert alert-success" *ngIf="success" (click)="success = ''">
    {{ success }}
  </div>
  <div class="alert alert-danger" *ngIf="error" (click)="error = ''">
    {{ error }}
  </div>

  <!-- Formul√°rio de cria√ß√£o/edi√ß√£o de convidado -->
  <div class="convidados-form" *ngIf="showForm">
    <form [formGroup]="convidadosForm" (ngSubmit)="onSubmit()">
      <div class="form-row">
        <div class="form-group">
          <label for="name">Nome do Convidado *</label>
          <input 
            type="text" 
            id="name" 
            formControlName="name" 
            placeholder="Digite o nome do convidado"
            [class.invalid]="convidadosForm.get('name')?.invalid && convidadosForm.get('name')?.touched"
          >
          <div class="error-message" *ngIf="convidadosForm.get('name')?.invalid && convidadosForm.get('name')?.touched">
            <span *ngIf="convidadosForm.get('name')?.errors?.['required']">Nome √© obrigat√≥rio</span>
            <span *ngIf="convidadosForm.get('name')?.errors?.['minlength']">Nome deve ter pelo menos 3 caracteres</span>
          </div>
        </div>

        <div class="form-group">
          <label for="email">E-mail</label>
          <input 
            type="email" 
            id="email" 
            formControlName="email" 
            placeholder="Digite o e-mail do convidado"
          >
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="phone">Telefone</label>
          <input 
            type="tel" 
            id="phone" 
            formControlName="phone" 
            placeholder="Digite o telefone do convidado"
          >
        </div>

        <div class="form-group">
          <label for="groupId">Grupo</label>
          <select 
            id="groupId" 
            formControlName="groupId"
          >
            <option value="">Selecione um grupo</option>
            <option value="1">Fam√≠lia</option>
            <option value="2">Amigos</option>
            <option value="3">Trabalho</option>
            <option value="4">Outros</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="eventId">Evento *</label>
        <select 
          id="eventId" 
          formControlName="eventId"
          [class.invalid]="convidadosForm.get('eventId')?.invalid && convidadosForm.get('eventId')?.touched"
        >
          <option value="">Selecione o evento</option>
          <option *ngFor="let evento of eventos" [value]="evento.id">
            {{ evento.titulo }} - {{ formatarData(evento.data) }}
          </option>
        </select>
        <div class="error-message" *ngIf="convidadosForm.get('eventId')?.invalid && convidadosForm.get('eventId')?.touched">
          <span *ngIf="convidadosForm.get('eventId')?.errors?.['required']">Evento √© obrigat√≥rio</span>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="toggleForm()">
          Cancelar
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="loading || convidadosForm.invalid">
          {{ loading ? 'Salvando...' : (isEditing ? 'Atualizar Convidado' : 'Adicionar Convidado') }}
        </button>
      </div>
    </form>
  </div>

  <!-- Lista de convidados - apenas quando o formul√°rio n√£o estiver aberto -->
  <div class="convidados-lista" *ngIf="!showForm && !loading">
    
    <!-- Filtros e estat√≠sticas -->
    <div class="convidados-stats">
      <div class="stat-item">
        <span class="stat-number">{{ getConvidadosFiltrados().length }}</span>
        <span class="stat-label">Total de Convidados</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">{{ getConvidadosConfirmados() }}</span>
        <span class="stat-label">Confirmados</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">{{ getConvidadosPendentes() }}</span>
        <span class="stat-label">Pendentes</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">{{ getConvidadosEnviados() }}</span>
        <span class="stat-label">Convites Enviados</span>
      </div>
    </div>

    <!-- Filtro por evento -->
    <div class="filtro-eventos">
      <div class="filtro-header">
        <h3>Filtrar por Evento</h3>
        <button class="btn btn-secondary btn-small" (click)="limparFiltro()" *ngIf="eventoSelecionado">
          Limpar Filtro
        </button>
      </div>
      <div class="filtro-opcoes">
        <label for="filtroEvento">Escolha o Evento que deseja filtrar:</label>
        <select 
          id="filtroEvento" 
          [(ngModel)]="eventoSelecionado" 
          (change)="onEventoChange()"
          class="filtro-select"
        >
          <option value="">Todos os Eventos</option>
          <option *ngFor="let evento of eventos" [value]="evento.id">
            {{ evento.titulo }} - {{ formatarData(evento.data) }}
          </option>
        </select>
      </div>


    <!-- Visualiza√ß√£o em tabela -->
    <div class="convidados-tabela" *ngIf="getConvidadosFiltrados().length > 0">
      <h3>Convidados</h3>
      <div class="table-container">
        <table class="convidados-table">
          <thead>
            <tr>
              <th>Nome</th>
              <th>E-mail</th>
              <th>Telefone</th>
              <th>Grupo</th>
              <th>Evento</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let convidado of getConvidadosFiltrados()" class="convidado-row" (click)="editarConvidado(convidado)">
              <td class="nome-cell">
                <div class="convidado-info">
                  <strong>{{ convidado.name }}</strong>
                </div>
              </td>
              <td class="email-cell">
                <span *ngIf="convidado.email">{{ convidado.email }}</span>
                <span *ngIf="!convidado.email" class="text-muted">-</span>
              </td>
              <td class="phone-cell">
                <span *ngIf="convidado.phone">{{ convidado.phone }}</span>
                <span *ngIf="!convidado.phone" class="text-muted">-</span>
              </td>
              <td class="grupo-cell">
                <span class="grupo-badge">{{ getGrupoText(convidado.groupId) }}</span>
              </td>
              <td class="evento-cell">
                <span>{{ getEventoById(convidado.eventId)?.titulo || '-' }}</span>
              </td>
              <td class="status-cell">
                <span class="status-badge" [class]="getStatusClass(convidado)">
                  {{ getStatusText(convidado) }}
                </span>
              </td>
              <td class="acoes-cell">
                <div class="acoes-buttons">
                  <button class="btn-icon" 
                          [class.btn-success]="convidado.confirmed" 
                          [class.btn-warning]="!convidado.confirmed"
                          (click)="toggleConfirmacao(convidado); $event.stopPropagation()" 
                          title="Confirmar presen√ßa">
                    {{ convidado.confirmed ? '‚úì' : '‚óã' }}
                  </button>
                  <button class="btn-icon" 
                          *ngIf="!convidado.sent"
                          (click)="enviarConvite(convidado); $event.stopPropagation()" 
                          title="Enviar convite">
                    üìß
                  </button>
                  <button class="btn-icon" 
                          *ngIf="convidado.sent && !convidado.confirmed"
                          (click)="reenviarConvite(convidado); $event.stopPropagation()" 
                          title="Reenviar convite">
                    üîÑ
                  </button>
                  <button class="btn-icon btn-delete" 
                          (click)="deletarConvidado(convidado.id!); $event.stopPropagation()" 
                          title="Deletar convidado">
                    üóëÔ∏è
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Estado vazio -->
    <div class="empty-state" *ngIf="getConvidadosFiltrados().length === 0">
      <div class="empty-icon">üë•</div>
      <h3>Nenhum convidado encontrado</h3>
      <p *ngIf="!eventoSelecionado">Clique em "Novo Convidado" para adicionar seus primeiros convidados!</p>
      <p *ngIf="eventoSelecionado">Nenhum convidado encontrado para o evento selecionado.</p>
    </div>
  </div>

  <!-- Loading state - apenas quando n√£o estiver mostrando o formul√°rio -->
  <div class="loading-state" *ngIf="loading && !showForm">
    <div class="spinner"></div>
    <p>Carregando convidados...</p>
  </div>
</div>
